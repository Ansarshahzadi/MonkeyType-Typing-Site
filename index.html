<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monkeytype Style Typing Test</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .topbar span.active {
        color: rgb(234, 88, 12) !important;
        font-weight: bold;
      }
    </style>
  </head>
  <body style="background: #fff; color: #222; font-family: monospace">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-white sticky-top w-100">
      <div class="container-fluid px-5">
        <a href="#" class="navbar-brand fw-bold fs-1">
          <span class="text-dark"
            >Typing<span style="color: rgb(234 88 12)">Board</span></span
          >
        </a>
        <button class="btn rounded-pill border-0 btn-primary">
          <a class="text-decoration-none fw-bold text-white" href="index.html"
            >Sign In</a
          >
        </button>
      </div>
    </nav>

    <!-- Top bar -->
    <div
      class="d-flex justify-content-center align-items-center mx-auto gap-3 border-bottom w-50 topbar"
      style="background: #f1f1f1; padding: 10px; font-size: 14px"
    >
      <span id="words" class="active" style="cursor: pointer; color: #666">A words</span>
      <span id="punctuation" style="cursor: pointer; color: #666">@ punctuation</span>
      <span id="numbers" style="cursor: pointer; color: #666"># numbers</span>
      <span id="quote" style="cursor: pointer; color: #666">" quote</span>
      <span id="zen" style="cursor: pointer; color: #666">△ zen</span>
      <span id="btn15" style="cursor: pointer; color: #666">15</span>
      <span id="btn30" style="cursor: pointer; color: #666">30</span>
      <span id="btn60" style="cursor: pointer; color: #666">60</span>
      <span id="btn120" style="cursor: pointer; color: #666">120</span>
      <span id="gear" style="cursor: pointer; color: #666">⚙</span>
    </div>

    <!-- Timer -->
    <div class="text-center mt-3">
      ⏳ Time Left: <span id="timer">0:00</span>
    </div>

    <!-- Typing Area -->
    <div class="d-flex justify-content-center align-items-center"
      style="height: calc(80vh - 120px); text-align: center">
      <div
        id="textDisplay"
        style="font-size: 24px; line-height: 2rem; padding: 25px;
               max-width: 1050px; color: #333; margin: 0 auto; text-align: justify;">
      </div>
    </div>

    <!-- Custom Paragraph Box -->
    <div id="customParagraphBox"
      style="display: none; margin: 0 auto; text-align: center; max-width: 80%;">
      <textarea id="customParagraph" rows="6"
        placeholder="Type or paste your custom paragraph here..."
        style="background: #fafafa; border: 1px solid #ccc; color: #000;
               padding: 5px; font-family: monospace; width: 100%;"></textarea><br />
      <button class="btn btn-sm btn-warning mt-2" id="setParagraph">Set Paragraph</button>
    </div>

    <!-- Modal for Custom Time -->
    <div class="modal fade" id="timeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content rounded-3">
          <div class="modal-header">
            <h5 class="modal-title">Set Custom Time</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="input-group">
              <input type="number" id="customTimeInput" class="form-control"
                placeholder="Enter time" />
              <select id="timeUnit" class="form-select">
                <option value="sec">Seconds</option>
                <option value="min">Minutes</option>
                <option value="hr">Hours</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-warning" id="setCustomTime">Set Time</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const timerDisplay = document.getElementById("timer");
      const textDisplay = document.getElementById("textDisplay");
      const topbarBtns = document.querySelectorAll(".topbar span");
      const customBox = document.getElementById("customParagraphBox");

      let interval, timeLeft = 0, started = false;
      let currentText = "", currentIndex = 0, correct = 0, incorrect = 0;
      let totalTimeSelected = 60; // default

      function setActive(el) {
        topbarBtns.forEach((btn) => btn.classList.remove("active"));
        el.classList.add("active");
      }

      function formatTime(seconds) {
        let m = Math.floor(seconds / 60);
        let s = seconds % 60;
        return `${m}:${s.toString().padStart(2, "0")}`;
      }

      async function loadText(type) {
        try {
          const response = await fetch("english.json");
          const data = await response.json();
          const options = data[type];
          if (!options || options.length === 0) return;
          const randomIndex = Math.floor(Math.random() * options.length);
          currentText = options[randomIndex];
          currentIndex = 0;
          correct = 0;
          incorrect = 0;
          renderText();
        } catch (err) {
          console.error("Error loading JSON:", err);
        }
      }

      function renderText() {
        textDisplay.innerHTML = "";
        currentText.split("").forEach((ch) => {
          let span = document.createElement("span");
          span.innerText = ch;
          textDisplay.appendChild(span);
        });
      }

      function startCountdown() {
        started = true;
        interval = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = formatTime(timeLeft);
          if (timeLeft <= 0) {
            clearInterval(interval);
            finishTest();
          }
        }, 1000);
      }

      function finishTest() {
        started = false;
        clearInterval(interval);

        const totalTyped = correct + incorrect;
        const accuracy = totalTyped > 0 ? Math.round((correct / totalTyped) * 100) : 0;

        // ✅ WPM includes correct + incorrect
        const wpm = Math.round(totalTyped / 5 / ((totalTimeSelected - timeLeft || 1) / 60));

        const spans = textDisplay.querySelectorAll("span");
        let charStats = {}; 
        spans.forEach((span) => {
          const char = span.innerText;
          if (!charStats[char]) {
            charStats[char] = { total: 0, errors: 0 };
          }
          charStats[char].total++;
          if (span.style.color === "red") {
            charStats[char].errors++;
          }
        });

        const result = { wpm, accuracy, correct, incorrect,
                         totalTyped, time: totalTimeSelected, charStats };

        localStorage.setItem("typingResult", JSON.stringify(result));
        window.location.href = "result.html";
      }

      // ✅ Typing logic (auto next paragraph + WPM fix)
      document.addEventListener("keydown", (e) => {
        if (timeLeft > 0 && !started) startCountdown();
        if (!started) return;

        const spans = textDisplay.querySelectorAll("span");

        if (currentIndex < spans.length && e.key.length === 1) {
          const expected = spans[currentIndex].innerText;
          if (e.key === expected) {
            spans[currentIndex].style.color = "lightgrey";
            correct++;
          } else {
            spans[currentIndex].style.color = "red";
            incorrect++;
          }
          currentIndex++;

          // ✅ Load next paragraph when one is finished
          if (currentIndex === spans.length) {
            let activeType = document.querySelector(".topbar span.active").id;
            if (activeType !== "zen") {
              loadText(activeType);
            }
          }

        } else if (e.key === "Backspace" && currentIndex > 0) {
          currentIndex--;
          spans[currentIndex].style.color = "#333";
        }
      });

      // Button bindings
      document.getElementById("words").onclick = (e) => { 
        setActive(e.target); customBox.style.display = "none"; loadText("words"); 
      };
      document.getElementById("punctuation").onclick = (e) => { 
        setActive(e.target); customBox.style.display = "none"; loadText("punctuation"); 
      };
      document.getElementById("numbers").onclick = (e) => { 
        setActive(e.target); customBox.style.display = "none"; loadText("numbers"); 
      };
      document.getElementById("quote").onclick = (e) => { 
        setActive(e.target); customBox.style.display = "none"; loadText("quote"); 
      };
      document.getElementById("zen").onclick = (e) => { 
        setActive(e.target); textDisplay.innerHTML = ""; customBox.style.display = "block"; 
      };

      // Timer buttons
      function setTimer(sec, el) {
        setActive(el);
        timeLeft = sec;
        totalTimeSelected = sec;
        timerDisplay.textContent = formatTime(timeLeft);
      }
      document.getElementById("btn15").onclick = (e) => setTimer(15, e.target);
      document.getElementById("btn30").onclick = (e) => setTimer(30, e.target);
      document.getElementById("btn60").onclick = (e) => setTimer(60, e.target);
      document.getElementById("btn120").onclick = (e) => setTimer(120, e.target);

      // Custom time modal
      document.getElementById("gear").onclick = () => new bootstrap.Modal(document.getElementById("timeModal")).show();
      document.getElementById("setCustomTime").onclick = () => {
        let value = parseInt(document.getElementById("customTimeInput").value);
        let unit = document.getElementById("timeUnit").value;
        if (value > 0) {
          if (unit === "min") value *= 60;
          else if (unit === "hr") value *= 3600;
          timeLeft = value;
          totalTimeSelected = value;
          timerDisplay.textContent = formatTime(timeLeft);
          bootstrap.Modal.getInstance(document.getElementById("timeModal")).hide();
        }
      };

      loadText("words"); // default
    </script>
  </body>
</html>
