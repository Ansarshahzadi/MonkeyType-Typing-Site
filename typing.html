<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Typing Test – Light→Dark Letters</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      .btn-orange {
        background-color: rgb(234 88 12);
        color: white;
        border: none;
      }
      .btn-orange:hover {
        background-color: rgb(194 65 12);
        color: white;
      }
      .custom-time-input {
        width: 80px;
        font-size: 14px;
        padding: 2px 6px;
      }
      .dropdown-menu.show {
        display: block !important;
      }
    </style>
  </head>
  <body
    class="bg-white text-dark border d-flex flex-column align-items-center min-vh-100"
  >
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-white sticky-top w-100 border mb-5">
      <div class="container-fluid px-5">
        <!-- Brand -->
        <a href="#" class="navbar-brand fw-bold fs-4">
          <span class="text-dark"
            >Aero<span style="color: rgb(234 88 12)">Page</span></span
          >
        </a>

        <!-- Toggler -->
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menu -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link mx-3" href="#1st">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link mx-3" href="#2nd">Demos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link mx-3" href="#3rd">Features</a>
            </li>
          </ul>
          <a href="index.html">
            <button type="button" class="btn btn-orange px-4">Sign IN</button>
          </a>
        </div>
      </div>
    </nav>
    <!-- Header -->
    <div class="container d-flex flex-column justify-content-center align-items-center">
      <!-- Words -->
      <div
        id="words"
        class="text-center mb-4"
        style="
          max-width: 900px;
          line-height: 2.2;
          font-size: 22px;
          user-select: none;
        "
      ></div>

      <!-- Buttons + Stats -->
      <div
        class="d-flex flex-wrap align-items-center gap-3 py-3 justify-content-center"
      >
        <button id="startBtn" class="btn btn-orange">Start</button>
        <button id="resetBtn" class="btn btn-orange">Reset</button>
        <button
          id="customTextBtn"
          class="btn btn-orange"
          data-bs-toggle="modal"
          data-bs-target="#customTextModal"
        >
          Custom Text
        </button>

        <!-- Time Selection -->
        <div class="dropdown">
          <button class="btn btn-orange" type="button" id="timeMenuBtn">
            Select Time
          </button>
          <div
            class="dropdown-menu p-2"
            id="timeDropdown"
            style="min-width: 150px"
          >
            <a class="dropdown-item time-option" data-time="30" href="#">30s</a>
            <a class="dropdown-item time-option" data-time="60" href="#">60s</a>
            <a class="dropdown-item time-option" data-time="120" href="#"
              >120s</a
            >
            <div
              class="d-flex align-items-center gap-2 mt-1"
              onclick="event.stopPropagation()"
            >
              <input
                type="number"
                min="1"
                id="customTimeInput"
                class="form-control form-control-sm custom-time-input"
                placeholder="Custom s"
              />
              <button class="btn btn-sm btn-orange" id="applyCustomTime">
                Set
              </button>
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div
          class="stat px-3 py-1 rounded text-white"
          style="background-color: rgb(234 88 12)"
        >
          WPM: <span id="wpm">0</span>
        </div>
        <div
          class="stat px-3 py-1 rounded text-white"
          style="background-color: rgb(234 88 12)"
        >
          Accuracy: <span id="acc">100%</span>
        </div>
        <div
          class="stat px-3 py-1 rounded text-white"
          style="background-color: rgb(234 88 12)"
        >
          Errors: <span id="err">0</span>
        </div>
        <div
          class="stat px-3 py-1 rounded text-white"
          style="background-color: rgb(234 88 12)"
        >
          Time: <span id="time">00:00</span>
        </div>
      </div>

      <!-- Hidden Input -->
      <input
        id="focusTrap"
        type="text"
        autocomplete="off"
        autocapitalize="off"
        spellcheck="false"
        style="
          position: fixed;
          opacity: 0;
          pointer-events: none;
          height: 0;
          width: 0;
          border: 0;
          padding: 0;
        "
      />
    </div>

    <!-- Custom Text Modal -->
    <div
      class="modal fade"
      id="customTextModal"
      tabindex="-1"
      aria-labelledby="customTextLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="customTextLabel">Enter Custom Text</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form action="">
              <textarea
                id="customTextArea"
                class="form-control"
                rows="8"
                placeholder="Paste your text here..."
              ></textarea>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-orange"
              id="applyCustomTextBtn"
              data-bs-dismiss="modal"
            >
              Apply Text
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const black = "#000000";
      const lightGrey = "#bdbdbd";
      const wrong = "#e74c3c";
      const active = "#f1c40f";
      const done = "#bdbdbd"; // correct letters light grey

      const defaultText =
        "cartridges audience identify sadly ranking homeland tonight deposited bypass request person import widescreen class bull posed processors herb swift courtyard composition dependence cartridges audience identify sadly ranking homeland tonight deposited bypass request person import widescreen class bull posed processors herb swift courtyard composition dependence";

      // Check LocalStorage for saved custom text
      let savedText = localStorage.getItem("typing_customText");
      let wordsList = savedText
        ? savedText.split(/\s+/)
        : defaultText.split(/\s+/);

      const wordsBox = document.getElementById("words");
      const wpmEl = document.getElementById("wpm");
      const accEl = document.getElementById("acc");
      const errEl = document.getElementById("err");
      const timeEl = document.getElementById("time");
      const trap = document.getElementById("focusTrap");
      const startBtn = document.getElementById("startBtn");
      const resetBtn = document.getElementById("resetBtn");

      let iWord = 0,
        typed = "",
        startedAt = null,
        correctWords = 0;
      let totalTyped = 0,
        errors = 0,
        timer = null,
        elapsed = 0;
      let maxTime = 60;

      function renderWords() {
        wordsBox.innerHTML = "";
        wordsList.forEach((w, wi) => {
          const wSpan = document.createElement("span");
          wSpan.setAttribute("data-idx", wi);
          wSpan.style.margin = "0 6px";
          wSpan.style.color = wi === 0 ? active : black;
          wSpan.style.textDecoration = wi === 0 ? "underline" : "none";
          for (let ci = 0; ci < w.length; ci++) {
            const cSpan = document.createElement("span");
            cSpan.textContent = w[ci];
            cSpan.style.color = black;
            wSpan.appendChild(cSpan);
          }
          wSpan.appendChild(document.createElement("span")).textContent = " ";
          wordsBox.appendChild(wSpan);
        });
      }

      function currentWordSpan() {
        return wordsBox.querySelector(`span[data-idx="${iWord}"]`);
      }

      function repaintActiveWord() {
        const wSpan = currentWordSpan();
        if (!wSpan) return;
        const letters = [...wSpan.childNodes].filter((n) => n.nodeType === 1);
        const word = wordsList[iWord];
        wSpan.style.color = active;
        wSpan.style.textDecoration = "underline";
        for (let j = 0; j < word.length; j++) {
          const ch = letters[j];
          if (!ch) continue;
          if (j < typed.length) {
            ch.style.color = typed[j] === word[j] ? done : wrong;
          } else {
            ch.style.color = black;
          }
        }
        updateStats();
      }

      function finalizeWord() {
        const wSpan = currentWordSpan();
        const word = wordsList[iWord];
        const letters = [...wSpan.childNodes].filter((n) => n.nodeType === 1);
        const isCorrect = typed === word;
        if (isCorrect) {
          letters.forEach((l) => (l.style.color = done));
          correctWords++;
        } else {
          for (let j = 0; j < word.length; j++) {
            if (typed[j] === word[j]) letters[j].style.color = done;
            else {
              letters[j].style.color = wrong;
              errors++;
            }
          }
        }
        wSpan.style.textDecoration = "none";
        wSpan.style.color = isCorrect ? done : wrong;
        iWord++;
        typed = "";
        const next = currentWordSpan();
        if (next) {
          next.style.color = active;
          next.style.textDecoration = "underline";
          [...next.childNodes]
            .filter((n) => n.nodeType === 1)
            .forEach((l) => (l.style.color = black));
        } else finishTest();
        updateStats();
      }

      function updateStats() {
        const mins = elapsed / 60;
        const wpm = mins > 0 ? Math.round(correctWords / mins) : 0;
        const acc =
          totalTyped > 0
            ? Math.round(((totalTyped - errors) / totalTyped) * 100)
            : 100;
        wpmEl.textContent = wpm;
        accEl.textContent = acc + "%";
        errEl.textContent = errors;
      }

      function tick() {
        elapsed++;
        const remaining = maxTime - elapsed;
        if (remaining <= 0) {
          finishTest();
          return;
        }
        const m = String(Math.floor(remaining / 60)).padStart(2, "0");
        const s = String(remaining % 60).padStart(2, "0");
        timeEl.textContent = `${m}:${s}`;
        updateStats();
      }

      function finishTest() {
        clearInterval(timer);
        const mins = elapsed / 60;
        const wpm = mins > 0 ? Math.round(correctWords / mins) : 0;
        const acc =
          totalTyped > 0
            ? Math.round(((totalTyped - errors) / totalTyped) * 100)
            : 100;
        localStorage.setItem("typing_wpm", wpm);
        localStorage.setItem("typing_acc", acc);
        localStorage.setItem("typing_err", errors);
        localStorage.setItem("typing_time", elapsed);
        window.location.href = "result.html";
      }

      function restart() {
        iWord = 0;
        typed = "";
        startedAt = null;
        correctWords = 0;
        totalTyped = 0;
        errors = 0;
        elapsed = 0;
        clearInterval(timer);
        timer = null;
        wpmEl.textContent = "0";
        accEl.textContent = "100%";
        errEl.textContent = "0";
        const m = String(Math.floor(maxTime / 60)).padStart(2, "0");
        const s = String(maxTime % 60).padStart(2, "0");
        timeEl.textContent = `${m}:${s}`;
        renderWords();
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Tab") return;
        trap.focus();
        if (!startedAt && e.key.length === 1) {
          startedAt = Date.now();
          timer = setInterval(tick, 1000);
        }
        if (iWord >= wordsList.length) return;
        const word = wordsList[iWord];
        if (e.key === "Backspace") {
          e.preventDefault();
          if (typed.length > 0) {
            typed = typed.slice(0, -1);
            repaintActiveWord();
          }
          return;
        }
        if (e.key === " ") {
          e.preventDefault();
          finalizeWord();
          return;
        }
        if (e.key.length === 1) {
          if (typed.length < word.length + 20) {
            typed += e.key;
            totalTyped++;
            repaintActiveWord();
          }
        }
      });

      startBtn.addEventListener("click", () => {
        restart();
        trap.focus();
        startedAt = Date.now();
        timer = setInterval(tick, 1000);
      });
      resetBtn.addEventListener("click", () => {
        wordsList = defaultText.split(/\s+/);
        localStorage.removeItem("typing_customText");
        restart();
      });

      // // Modal Apply Custom Text
      // const customTextArea = document.getElementById("customTextArea");
      // const applyCustomTextBtn = document.getElementById("applyCustomTextBtn");
      // applyCustomTextBtn.addEventListener("click", () => {
      //   const text = customTextArea.value.trim();
      //   if (text.length > 0) {
      //     wordsList = text.split(/\s+/);
      //     localStorage.setItem("typing_customText", text);
      //     restart();
      //   }
      // });

      // document
      //   .getElementById("customTextModal")
      //   .addEventListener("show.bs.modal", () => {
      //     const saved = localStorage.getItem("typing_customText");
      //     customTextArea.value = saved ? saved : "";
      //   });

      // Time Selection
      const timeMenuBtn = document.getElementById("timeMenuBtn");
      const timeDropdown = document.getElementById("timeDropdown");
      const customTimeInput = document.getElementById("customTimeInput");
      const applyCustomTime = document.getElementById("applyCustomTime");

      timeMenuBtn.addEventListener("click", () => {
        timeDropdown.classList.toggle("show");
      });
      customTimeInput.addEventListener("click", (e) => e.stopPropagation());
      customTimeInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") setCustomTime();
      });
      applyCustomTime.addEventListener("click", setCustomTime);
      document.addEventListener("click", (e) => {
        if (!timeDropdown.contains(e.target) && e.target !== timeMenuBtn)
          timeDropdown.classList.remove("show");
      });
      function setCustomTime() {
        const val = parseInt(customTimeInput.value);
        if (!isNaN(val) && val > 0) {
          maxTime = val;
          restart();
          customTimeInput.value = "";
          timeDropdown.classList.remove("show");
        }
      }

      document.addEventListener("pointerdown", () => trap.focus());

      // ✅ Correct Initialization
      window.onload = () => {
        restart();
        trap.focus();
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
